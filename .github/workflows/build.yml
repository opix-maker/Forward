name: Build IMDb Discovery Engine Data

on:
  workflow_dispatch: 
  schedule:
    - cron: '0 */12 * * *' 

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-build 
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      # --- 1-3. 设置环境和数据缓存  ---
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current date for cache key (UTC)
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache IMDb datasets and temp datalake
        id: cache-imdb-data
        uses: actions/cache@v4
        with:
          path: |
            imdb-data-platform/datasets/
            imdb-data-platform/temp/
          key: ${{ runner.os }}-imdb-data-${{ steps.date.outputs.date }}
          restore-keys: |
            ${{ runner.os }}-imdb-data-

      # --- 4-5. 安装和构建  ---
      - name: Install dependencies
        working-directory: ./imdb-data-platform
        run: npm install

      - name: Run build script
        working-directory: ./imdb-data-platform
        env:
          TMDB_ACCESS_TOKEN_V4: ${{ secrets.TMDB_ACCESS_TOKEN_V4 }} 
        run: npm run build 


      - name: Free up disk space
        run: |
          echo "Deleting large intermediate and raw data files..."
          rm -rf imdb-data-platform/datasets  # 删除原始 IMDb 数据 (释放 3-5 GB)
          rm -rf imdb-data-platform/temp      # 删除中间数据湖
          rm -rf imdb-data-platform/node_modules # 删除依赖
          echo "Disk space freed. Ready for deployment."

      # --- 6. 准备部署暂存区 ---
      - name: Prepare deployment staging area
        run: |
          mkdir -p deployment_staging
          echo "Moving final build artifacts to staging area..."
          shopt -s dotglob # 确保隐藏文件也被移动
          # 将最终结果 (dist/) 移动到干净的暂存区
          mv imdb-data-platform/dist/* deployment_staging/
          echo "Moved 160k+ files to deployment_staging/"

      # --- 7. 分块提交和部署  ---
      - name: Deploy data with chunked git operations
        uses: EndBug/add-and-commit@v9
        with:
          branch: data-deploy
          cwd: './deployment_staging'
          message: 'Deploy: Automated data update (${{ steps.date.outputs.date }})'
          add: '.'
          # 分块处理，每批 5000 个文件
          split: 5000 
          # 覆盖目标分支
          push: 'origin data-deploy --force' 
          remove: '.' 
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- 8. 失败通知 ---
      - name: Notify on Failure
        if: failure() 
        run: echo "❌ Build workflow failed! Check logs."
